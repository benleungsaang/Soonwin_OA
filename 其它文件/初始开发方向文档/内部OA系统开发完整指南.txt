内部OA系统开发完整指南

一、整体技术架构

核心技术栈：
- 后端：Python 3.8+ + Flask 2.3+
- 前端：Vue3 + Vite + Element Plus
- 数据库：SQLite3
- 内网穿透：花生壳免费版
- 认证方式：无密码TOTP动态验证码登录

系统拓扑：
- 核心服务器：固定内网IP（如192.168.1.100）
- 服务端口：5000
- 前端静态文件：打包后放入Flask静态目录

二、开发阶段规划

第一阶段：后端核心开发（第1-2天）
1. 环境搭建
   - 搭建Python+Flask开发环境
   - 安装依赖库（Flask-SQLAlchemy、Flask-CORS、pyotp、qrcode等）
   - 复制并配置app.py核心代码

2. 数据库设计
   - 初始化SQLite3数据库
   - 创建四张核心表：员工信息表、打卡记录表、订单表、TOTP用户表
   - 配置数据库连接参数，避免锁死问题

3. 无感NFC打卡功能
   - 实现IP+MAC地址识别逻辑
   - 开发打卡核心接口
   - 完成飞书Webhook推送功能
   - 实现防作弊机制（内网IP段验证、重复打卡限制）

第二阶段：前端开发（第3-4天）
1. 环境搭建
   - 搭建Vue3+Vite+Element Plus环境
   - 集成Element Plus UI组件库

2. 页面开发
   - 首页（NFC打卡说明、TOTP登录入口、订单模块入口）
   - 打卡成功页（展示打卡结果）
   - 订单模块（登录页、列表页、增删改查功能）

3. 接口对接
   - 对接后端API接口
   - 实现TOTP登录验证
   - 完成订单增删改查功能

第三阶段：测试与部署（第5天）
1. 内网测试
   - 组织员工测试NFC打卡
   - 验证订单功能完整性
   - 确认飞书推送正常

2. 花生壳配置
   - 配置内网穿透
   - 测试外网访问
   - 验证流量管控功能

第四阶段：优化与备份（第6-7天）
1. 系统优化
   - 前端页面样式优化
   - 响应式适配（手机/电脑）
   - 性能优化

2. 数据安全
   - 建立数据库备份机制
   - 完善日志记录
   - 验证系统稳定性

三、开发流程指引

1. 后端开发流程
   - 配置文件设置：设置app.py中的关键配置参数
   - 数据库模型创建：按文档中的表结构创建模型
   - 接口开发顺序：
     - 打卡接口（优先级最高）
     - TOTP认证接口
     - 订单管理接口
     - 附件管理接口

2. 前端开发流程
   - 页面结构规划：按照三个核心页面设计
   - 组件开发：使用Element Plus组件库
   - 状态管理：使用简单的组件内状态，无需复杂状态管理器
   - 接口集成：统一使用axios进行API调用

3. 测试流程
   - 单元测试：测试核心打卡和认证功能
   - 集成测试：前后端联调测试
   - 用户测试：员工实际使用测试
   - 外网测试：花生壳映射功能验证

四、关键技术实现方案

1. 无感NFC打卡实现
   - 身份识别：通过request.remote_addr获取内网IP，用arp命令解析MAC地址
   - 防作弊机制：内网IP段白名单 + MAC+IP双绑定 + 重复打卡限制
   - 自动打卡：NFC贴纸写入固定URL，贴卡后自动完成打卡流程

2. 无密码TOTP登录实现
   - 密钥生成：为每个员工生成唯一TOTP密钥
   - 二维码绑定：员工使用身份验证器APP扫码绑定
   - 动态验证：每30秒刷新的6位动态码认证

3. 订单管理功能
   - 完整字段支持：包含序号、新旧、地区、客户名称等全部29个字段
   - 权限控制：TOTP认证后才能访问订单模块
   - 附件管理：支持图片/视频上传和预览
   - 数据导出：支持Excel格式导出

4. 流量管控策略
   - 外网限制：花生壳映射仅开放打卡和订单查看
   - 视频屏蔽：外网访问时自动屏蔽视频播放接口
   - 内网无限制：内网环境下视频功能正常使用

五、部署与运维指引

1. 服务器配置
   - 固定IP：给运行Flask的电脑绑定固定内网IP
   - 开机自启：设置Flask服务和花生壳客户端开机自启
   - 系统监控：定期检查服务运行状态

2. 数据安全
   - 备份策略：每天手动备份SQLite3数据库文件
   - 日志管理：双重存储打卡记录（数据库+文本日志）
   - 权限管理：严格控制数据库访问权限

3. 扩展预留
   - 数据库迁移：预留MySQL切换接口
   - 功能扩展：机器计价和视频管理功能预留
   - 升级路径：花生壳付费版升级方案

六、注意事项

1. 开发原则：轻量化、内网优先、无感体验、低成本落地
2. 安全要求：严格限制外网访问，保护敏感数据
3. 兼容性：确保适配PC和手机浏览器
4. 稳定性：SQLite3配置优化，避免锁死问题

七、第一阶段：后端核心开发验证方案

验证方式：
1. 单元测试验证
   - 使用Python unittest或pytest框架
   - 验证各个API接口的响应状态码
   - 验证数据库操作的正确性

2. 功能测试验证
   - 直接调用API接口进行测试
   - 使用Postman或curl工具验证接口功能
   - 检查数据库记录创建、更新、删除的正确性

3. 集成测试验证
   - 验证各模块之间的数据流转
   - 测试Flask应用的整体运行状态
   - 验证与外部服务（飞书Webhook）的连接

验证点：
1. 环境搭建验证点
   - Python环境版本是否正确（3.8+）
   - Flask框架是否正确安装（2.3+）
   - 依赖库（Flask-SQLAlchemy、Flask-CORS、pyotp、qrcode等）是否安装成功
   - app.py配置是否正确加载

2. 数据库设计验证点
   - SQLite3数据库文件是否成功创建
   - 四张核心表（员工信息表、打卡记录表、订单表、TOTP用户表）是否按设计创建
   - 表字段类型、约束是否正确
   - 数据库连接参数是否配置正确（防锁死设置）

3. NFC打卡功能验证点
   - IP地址获取是否正确：验证request.remote_addr返回值
   - MAC地址解析是否准确：验证arp命令解析结果
   - 打卡接口(/punch)响应状态码（200成功、403非内网、400未绑定设备）
   - 飞书Webhook推送是否成功发送
   - 防作弊机制：内网IP段验证是否生效
   - 重复打卡限制是否生效（30分钟内不能重复打卡）
   - 打卡记录是否正确写入数据库

4. TOTP认证功能验证点
   - TOTP密钥生成是否成功
   - 二维码生成和展示是否正确
   - 动态验证码验证是否准确（30秒内有效）
   - 登录状态管理是否正常（session）
   - 登录验证中间件是否按预期工作

八、第二阶段：前端开发验证方案

验证方式：
1. 页面功能验证
   - 在浏览器中直接测试页面功能
   - 检查UI组件是否正常渲染
   - 验证页面交互逻辑

2. 接口对接验证
   - 使用浏览器开发者工具检查API请求
   - 验证数据传输的正确性
   - 检查错误处理逻辑

3. 响应式测试验证
   - 在不同设备尺寸下测试页面显示
   - 验证移动端和桌面端的兼容性

验证点：
1. 环境搭建验证点
   - Vue3和Vite是否正确安装
   - Element Plus UI组件库是否集成成功
   - 开发服务器是否正常启动

2. 页面开发验证点
   - 首页是否正确显示NFC打卡说明、TOTP登录入口、订单模块入口
   - 打卡成功页是否正确显示员工姓名、工号、打卡类型、时间
   - 订单模块页面是否包含登录页、列表页、筛选栏、导出按钮
   - 页面路由是否按设计实现

3. 接口对接验证点
   - 打卡接口调用是否成功
   - TOTP登录接口调用和验证是否正常
   - 订单增删改查接口是否正常工作
   - 登录状态检查是否有效

4. 状态管理验证点
   - 组件内状态管理是否正确
   - API错误处理是否按预期工作
   - 用户认证状态是否正确维护

九、第三阶段：测试与部署验证方案

验证方式：
1. 内网测试验证
   - 组织实际员工进行功能测试
   - 使用真实设备验证NFC打卡功能
   - 验证飞书推送是否正常到达

2. 外网测试验证
   - 通过花生壳映射的域名访问系统
   - 验证外网访问功能是否受限
   - 检查流量管控是否生效

3. 性能测试验证
   - 测试系统在多用户并发访问下的表现
   - 验证数据库查询性能
   - 检查系统响应时间

验证点：
1. 内网测试验证点
   - 员工NFC打卡是否成功（连内网WiFi+贴NFC即可打卡）
   - 员工打卡信息是否正确记录
   - 飞书推送消息是否正确发送
   - 订单功能是否按预期工作
   - 前端页面在内网环境下是否正常显示

2. 花生壳配置验证点
   - 内网穿透是否成功建立
   - 外网域名是否可以正常访问
   - 打卡功能在外网是否可用
   - 订单查看功能在外网是否可用
   - 视频模块是否在外网被正确屏蔽

3. 安全验证点
   - 外网访问限制是否生效
   - 敏感数据是否得到有效保护
   - 认证机制是否正常工作

十、第四阶段：优化与备份验证方案

验证方式：
1. 性能优化验证
   - 使用浏览器开发者工具分析页面加载时间
   - 检查API响应时间
   - 验证缓存机制是否生效

2. 兼容性测试验证
   - 在不同浏览器中测试系统功能
   - 验证手机和电脑端显示效果
   - 检查不同分辨率下的页面表现

3. 数据安全验证
   - 验证数据库备份是否成功
   - 检查日志记录是否完整
   - 确认系统稳定性

验证点：
1. 系统优化验证点
   - 前端页面加载速度是否提升
   - 响应式设计是否适配各种设备
   - 用户界面是否美观易用
   - 系统性能是否稳定

2. 数据安全验证点
   - 数据库备份文件是否完整
   - 日志记录是否包含必要信息
   - 系统运行是否稳定无异常

3. 运维验证点
   - 系统是否支持长时间稳定运行
   - 服务重启后是否能正常恢复
   - 监控机制是否有效